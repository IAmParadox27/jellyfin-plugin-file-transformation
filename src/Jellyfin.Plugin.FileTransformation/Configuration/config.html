<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>File Transformation</title>
</head>
<body>
<div data-role="page" id="fileTransformationConfigurationPage" class="page type-interior pluginConfigurationPage fullWidthContent">
    <div class="content-primary">
        <div class="verticalSection">
            <div class="sectionTitleContainer">
                <h2 class="sectionTitle">File Transformation</h2>
                <a is="emby-linkbutton" class="raised raised-mini" style="margin-left: 2em;" target="_blank"
                   href="https://github.com/IAmParadox27/jellyfin-plugin-file-transformation">
                    <i class="md-icon button-icon button-icon-left secondaryText"></i>
                    <span>Help</span>
                </a>
            </div>
        </div>
        <hr class="solid">

        <!-- Might need to revisit the 95% here to make it responsive --> 
        <form class="fileTransformationConfigurationForm" style="max-width: 95%">
            <div id="configurationWrapper">
                <div class="inputContainer">
                    <span>Debug Logging: </span>
                    <select is="emby-select" class="emby-select-withcolor emby-select" data-id="debugLoggingSelect">
                        <option value="Enabled">Enabled</option>
                        <option value="Disabled">Disabled</option>
                    </select>
                    <span>Whether the plugin should output debug logging. (Note this will slow down your page response time, only enable this if you're creating an issue on GitHub to provide additional information)</span>
                </div>
            </div>
            <br />
            <table>
                <thead>
                    <tr>
                        <th style="vertical-align: top;width: 33%;text-align: left;">Filename Pattern<br/><br /><span style="font-size: 75%; font-weight: normal; font-style: italic;">The regex pattern of the filename you wish to modify. <i>Exact filenames are supported and checked first.</i></span></th>
                        <th style="vertical-align: top;width: 33%;text-align: left;">Search String<br/><br/><span style="font-size: 75%; font-weight: normal; font-style: italic;">The text that should be looked for in the file to be replaced.</span></th>
                        <th style="vertical-align: top;width: 34%;text-align: left;">Replacement String<br/><br/><span style="font-size: 75%; font-weight: normal; font-style: italic;">The text that should replace the Search String in the file.  If you are inserting code/elements, ensure that you append or prepend the original search string into this replacement.</span></th>
                        <th style="vertical-align: top;text-align: right;"><button is="emby-button" id="add-custom-button" type="button" class="raised button-submit block">Add</button></th>
                    </tr>
                </thead>
                <tbody id="configs-host"></tbody>
            </table>
            <br />
            <button id="saveConfig" is="emby-button" type="submit" class="raised button-submit block">
                <span>Save</span>
            </button>
        </form>
    </div>
    <template id="pluginConfiguredTransformationTemplate">
        <tr>
            <td style="vertical-align: top">
                <input class="emby-input" type="text" data-id="txtFilenamePattern" />
                <input type="hidden" data-id="metaTransformationId" />
            </td>
            <td style="vertical-align: top">
                <textarea style="font-family: 'Courier New', monospace;display:block;resize: vertical" class="emby-textarea emby-input" data-id="txtSearchString"></textarea>
            </td>
            <td style="vertical-align: top">
                <textarea style="font-family: 'Courier New', monospace;display:block;resize: vertical" class="emby-textarea emby-input" data-id="txtReplaceString"></textarea>
            </td>
            <td style="vertical-align: top;text-align: right;"><button is="emby-button" data-id="remove-button" type="button" class="raised button-submit block">Remove</button></td>
        </tr>
    </template>
    <script type="text/javascript">
        if (typeof FileTransformation == 'undefined') {
            
            const FileTransformation = {
                pluginId: "5e87cc92-571a-4d8d-8d98-d2d4147f9f90",
                configurationWrapper: document.querySelector("#configurationWrapper"),
                configsHost: document.querySelector("#configs-host"),

                btnSave: document.querySelector("#saveConfig"),
                btnAddCustom: document.querySelector("#add-custom-button"),

                saveConfig: function (e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();
                    
                    let transformations = [];
                    
                    document.querySelectorAll("#configs-host tr").forEach(function (tr) {
                        const metaTransformationId = tr.querySelector("[data-id=metaTransformationId]").value;
                        const filenamePattern = tr.querySelector("[data-id=txtFilenamePattern]").value;
                        const searchString = tr.querySelector("[data-id=txtSearchString]").value;
                        const replaceString = tr.querySelector("[data-id=txtReplaceString]").value;
                        
                        transformations.push({
                            Id: metaTransformationId,
                            FilenamePattern: filenamePattern,
                            SearchText: searchString,
                            ReplaceText: replaceString
                        })
                    })
                    
                    const config = {
                        DebugLoggingState: document.querySelector("[data-id=debugLoggingSelect]").value,
                        Transformations: transformations
                    };

                    window.ApiClient.updatePluginConfiguration(FileTransformation.pluginId, config)
                        .then(Dashboard.processPluginConfigurationUpdateResult)
                        .catch(function (error) {
                            console.error(error);
                        })
                        .finally(function () {
                            Dashboard.hideLoadingMsg();
                        });
                },
                loadConfig: function () {
                    Dashboard.showLoadingMsg();
                    window.ApiClient.getPluginConfiguration(FileTransformation.pluginId)
                        .then(function (config) {
                            document.querySelector("[data-id=debugLoggingSelect]").value = config.DebugLoggingState;
                            
                            config.Transformations.forEach(FileTransformation.addNewConfig);
                        })
                        .catch(function (error) {
                            console.error(error);
                        })
                        .finally(function () {
                            Dashboard.hideLoadingMsg();
                        });
                },
                addNewConfig: function (config = undefined) {
                    if (config === undefined) {
                        config = {
                            Id: crypto.randomUUID(),
                            FilenamePattern: "",
                            SearchText: "",
                            ReplaceText: ""
                        };
                    }
                    
                    const template = document.querySelector("#pluginConfiguredTransformationTemplate");
                    const clone = template.content.cloneNode(true);
                    clone.querySelector("[data-id=metaTransformationId]").value = config.Id;
                    clone.querySelector("[data-id=txtFilenamePattern]").value = config.FilenamePattern;
                    clone.querySelector("[data-id=txtSearchString]").value = config.SearchText;
                    clone.querySelector("[data-id=txtReplaceString]").value = config.ReplaceText;
                    
                    clone.querySelector("[data-id=remove-button]").addEventListener("click", FileTransformation.removeConfig);
                    
                    FileTransformation.configsHost.appendChild(clone);
                },
                removeConfig: function (e) {
                    FileTransformation.configsHost.removeChild(e.target.closest("tr"));
                },
                addNewConfigEvent: function (e) {
                    e.preventDefault();
                    FileTransformation.addNewConfig();
                },
                init: function () {
                    FileTransformation.btnSave.addEventListener("click", FileTransformation.saveConfig);
                    FileTransformation.btnAddCustom.addEventListener("click", FileTransformation.addNewConfigEvent);
                    FileTransformation.loadConfig();
                }
            }

            // view.addEventListener("viewshow", function (e) {
            document.querySelector('#fileTransformationConfigurationPage').addEventListener("pageshow", function () {
                FileTransformation.init();
            });
        }
    </script>
</div>
</body>
</html>